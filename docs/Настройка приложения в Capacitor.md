# Настройка приложения в Capacitor

## Подготовка приложения

- в envionment.js в backendUrl вместо localhost указать адрес ip, переменной locationType присвоить значение 'hash'
- в приложении должна быть папка dist или www куда будет собираться приложение
- в приложении должен присутствовать package.json файл и index.html в корневой директории проекта
- собрать приложение

## Настройка окружения

Для работы с андроид версией приложения должны быть установлены:

- Node не ниже 16 версии (у меня 17.1.0)
- Java подходящей версии (в моем случае 17)
- Gradle 8 версии
- Android Studio
- Android SDK (можно установить через андроид студию)

В Android Studio заходим в Tools -> SDK Manager. На вкладке SDK Platforms проверяем что установлены (или устанавливаем) пакеты:

![SDK Platforms](/docs/images/sdk-platforms.png)

В примере используется андроид 13 (просто 13, без Extension Level) версии и пакеты sdk версии 33. Лишних пакетов других версий лучше не ставить, т.к. это может привести к ошибкам. Чтобы увидеть детали пакетов, нужно проставить соответствующую галочку внизу.

На вкладке SDK Tools должны быть установлены следующие инструменты:

![SDK Tools](/docs/images/sdk-tools.png)

Android SDK Build-Tools (на скрине сверху в свернутом виде) установлен 33 версии.

В переменных среды должны быть:

- в Path:
  - путь до джавы (jdk-17\bin)
  - \android-sdk
  - \android-sdk\cmdline-tools\latest\bin
  - \android-sdk\platform-tools
  - \android-sdk\build-tools
  - \Gradle\gradle-8.1.1\bin
- в JAVA_HOME - \jdk-17\jdk-17
- в ANDROID_HOME - \android-sdk
- в ANDROID_SDK_ROOT - \android-sdk

## Устанавливаем и настраиваем Capacitor

В корневой директории приложения выполняем:

    npm i @capacitor/core
    npm i -D @capacitor/cli

Затем инициализируем:

    npx cap init

Консоль спросит название приложения и package ID. Например, можно прописать "ember-flexberry-gis" и "com.flexberry.app" соответственно.

Устанавливаем платформу андроид для капаситора:

    npm i @capacitor/android

Пакеты капаситора должны добавиться в package.json. Теперь можно создать андроид приложение:

    npx cap add android

После чего синхронизировать свое приложение с созданным андроид приложением:

    npx cap sync

Можно открыть приложение в андроид студии командой:

    npx cap open android

В android/app/src/main/AndroidManifest.xml добавляем разрешения для сетевого взаимодействия:

```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
```

И там же разрешаем доступ по http:

```xml
<application
	...
    android:usesCleartextTraffic="true"
    ...
</application>
```

Запустить андроид приложение можно из консоли (но у меня с этим были проблемы, см. раздел об ошибках ниже) командой:

    npx cap run android

Можно запустить андроид приложение из андроид студии. При запуске нужно обратить внимание, какой эмулятор используется.

![Emulator on launch](/docs/images/emulator-on-launch.png)

Если выбран неправильный эмулятор, запуск может завершиться ошибкой. Если эмулятор правильный, можно попробовать перезапустить эмулятор:

![Device manager](/docs/images/device-manager.png)

При успешном запуске должно открыться приложение:

![App launched](/docs/images/app-launched.png)

Чтобы собрать .apk файл можно также воспользоваться студией. Выбираем в меню Build -> Generate Signed Bundle/APK. В открывшемся окне выбираем APK. На следующем шаге нажимаем кнопку Create new, чтобы создать экземпляр файла и заполняем поля. Либо можно выбрать уже имеющийся и обновить его.

## Возможные ошибки

`ERR_SDK_PACKAGE_NOT_FOUND` - не все необходимые инструменты установлены.

`ERR_UNSUPPORTED_API_LEVEL`: Unsupported API level - документация говорит, что используются неподдерживаемые версии инструментов андроид. Последняя поддерживаемая версия - 33, наименьшая - что-то около 20. Если Android SDK входит в этот промежуток, то можно воспользоваться следующим костылем: создать в андроид студии пустой проект и попытаться запустить его, или запустить там отдельно только эмулятор. После чего попытаться продолжить работу дальше по плану. Этот и другие варианты решения ошибки можно посмотреть [здесь](https://github.com/ionic-team/native-run/issues/196).

При попытке запустить андроид приложение из консоли падают ошибки - может быть связано с несоответствием эмуляторов. С помощью команды adb devices -l можно посмотреть запущенные эмуляторы, но там нет нужного. Можно создать и добавить вручную, но я запускаю из андроид студии вместо консоли.

`android emulator process system isn't responding` / `system ui isn't responding` и прочие похожие ошибки на экране эмулятора - не хватает ресурсов компьютера. Может помочь перезапуск эмулятора. Если ошибки повторяются - можно уменьшить разрешение эмулятора. Заходим в настройки эмулятора по кнопке edit:

![Edit emulator](/docs/images/edit-emulator.png)

В открывшемся окне настройки выбираем разрешение поменьше. Также обращаем внимание, что используется эмулятор x86_64 (а не просто x86). Затем нажимаешь кнопку Finish.

![Device configuration](/docs/images/device-configuration.png)

Эмулятор виснет при загрузке на экране заставки - может зависнуть эмулятор, открываем диспетчер задач, ищем процесс qemu-system-x86_64 и завершаем его. Можно и всю студию перезапустить.
