<div class="ui vertical menu">
  <iframe id="testframe"
    src="../../api-test-map/51099a34-7b54-487e-868d-c44290edcded?lat=58.03537122378858&lng=56.19266510009766&zoom=11"
    width="1000" height="800" align="left">
  </iframe>
  <button id="showLayers">Show Layers</button>
  <button id="hideLayers">Hide Layers</button>
  <button id="queryLayers">Query Layers</button>
  <button id="getIntersectionObjects">get Intersection Objects</button>
  <button id="createNewlayer">Create new Layer</button>
  <button id="showAllLayerObjects">Show all layer objects</button>
  <div>
    <textarea id="layerObjects" name="text" style="width:750px;height:100px"></textarea>
    <br />
    <button id="deleteLayerObjects">Delete object/objects</button>
    <button id="showObjects">Show Objects</button>
    <button id="hideObjects">Hide Objects</button>
  </div>
  <script type="text/javascript">
    var frame = document.getElementById("testframe");
    frame.addEventListener("load", function () {
      if (frame.contentWindow.mapApi == undefined) {
        frame.contentWindow.mapApi = {};
      }

      frame.contentWindow.mapApi.goToEditForm = function (layerId, objectId) {
        console.log(`Go to edit form for element ${objectId}.`);
      }

      frame.contentWindow.mapApi.hasEditForm = function (layerId, objectId) {
        return true;
      }

      frame.contentWindow.mapApi.goToListForm = function (layerId, objectIds) {
        console.log(`Go to list form for elements ${objectIds}.`);
      }

      frame.contentWindow.mapApi.hasListForm = function (layerId) {
        return true;
      }

      frame.contentWindow.mapApi.layerInitCallback = function (model) {
        model.getLeafletObject().then(function (layer) {
          layer.eachLayer(function (layerr) {
            switch (model.layerModel.get('id')) {
              case 'f7670a1f-1acb-4571-923c-1ce3bc88e11e':
                layerr.setStyle({ color: '#808000', fillColor: '#FFD700' });
                break;
              case 'f8dec493-d879-49ae-ad55-f4f18c89cb88':
                layerr.setStyle({ color: '#008B8B' });
                break;
            }

            layerr.on('click', function (e) {
              alert(e.target.feature.properties.name);
            })
          });
        });
      };

      var showButton = document.getElementById('showLayers');
      var showLayers = function () {
        frame.contentWindow.mapApi.mapModel.showLayers(['f7670a1f-1acb-4571-923c-1ce3bc88e11e', 'f8dec493-d879-49ae-ad55-f4f18c89cb88']);
      };
      showButton.addEventListener('click', showLayers);

      var hideButton = document.getElementById('hideLayers');
      var hideLayers = function () {
        frame.contentWindow.mapApi.mapModel.hideLayers(['f7670a1f-1acb-4571-923c-1ce3bc88e11e', 'f8dec493-d879-49ae-ad55-f4f18c89cb88']);
      };
      hideButton.addEventListener('click', hideLayers);

      var queryButton = document.getElementById('queryLayers');
      var queryLayers = function () {
        frame.contentWindow.mapApi.runQuery({ waterway: 'drain', name: 'Гайва' }, 'c2ce814e-cb31-432e-af9e-2e86cea65c67');
      };
      queryButton.addEventListener('click', queryLayers);

      var intersectionButton = document.getElementById('getIntersectionObjects');
      var getIntersections = function () {
        console.log(frame.contentWindow.mapApi.mapModel.getIntersectionObjects('perm_water_line.7836', ['f8dec493-d879-49ae-ad55-f4f18c89cb88']));
      };
      intersectionButton.addEventListener('click', getIntersections);

      var newLayerButton = document.getElementById('createNewlayer');
      var newLayer = function () {
        frame.contentWindow.mapApi.mapModel.createNewLayer({ name: 'test_osm', type: 'osm' }).then(id => console.log(id));
      };
      newLayerButton.addEventListener('click', newLayer);

      textaeraDelObj = {
        layerId: 'f8dec493-d879-49ae-ad55-f4f18c89cb88', objectIds: ['perm_water_line.8383', 'perm_water_line.8382']
      };
      layerObjects.value = JSON.stringify(textaeraDelObj);

      var deleteObjectsLayerButton = document.getElementById('deleteLayerObjects');
      var deleteObjectsLayer = function () {
        var layerObjects = document.getElementById('layerObjects');
        var delObj = JSON.parse(layerObjects.value);

        if (delObj.layerId !== undefined) {
          var promise;
          if (delObj.objectIds.length > 1) {
            promise = frame.contentWindow.mapApi.mapModel.deleteLayerObjects(delObj.layerId, delObj.objectIds);
          } else if (delObj.objectIds.length === 1) {
            promise = frame.contentWindow.mapApi.mapModel.deleteLayerObject(delObj.layerId, delObj.objectIds[0]);
          }

          promise.then(() => console.log(delObj.objectIds)).catch(() => console.log('Layer saving failed'));
        }
      };

      deleteObjectsLayerButton.addEventListener('click', deleteObjectsLayer);

      var showObjectsButton = document.getElementById('showObjects');
      var showObjects = function () {
        var layerObjects = document.getElementById('layerObjects');
        var visibilityObj = JSON.parse(layerObjects.value);

        if (visibilityObj.layerId !== undefined) {
          if (visibilityObj.objectIds.length > 0) {
            frame.contentWindow.mapApi.mapModel.showLayerObjects(visibilityObj.layerId, visibilityObj.objectIds);
          }
        };
      };

      showObjectsButton.addEventListener('click', showObjects);

      var hideObjectsButton = document.getElementById('hideObjects');
      var hideObjects = function () {
        var layerObjects = document.getElementById('layerObjects');
        var visibilityObj = JSON.parse(layerObjects.value);

        if (visibilityObj.layerId !== undefined) {
          if (visibilityObj.objectIds.length > 0) {
            frame.contentWindow.mapApi.mapModel.hideLayerObjects(visibilityObj.layerId, visibilityObj.objectIds);
          }
        };
      }

      hideObjectsButton.addEventListener('click', hideObjects);

      var showAllLayerObjectsButton = document.getElementById('showAllLayerObjects');
      var showAllLayerObjects = function () {
        frame.contentWindow.mapApi.mapModel.showAllLayerObjects('f8dec493-d879-49ae-ad55-f4f18c89cb88');
      }

      showAllLayerObjectsButton.addEventListener('click', showAllLayerObjects);
    });
  </script>
</div>
